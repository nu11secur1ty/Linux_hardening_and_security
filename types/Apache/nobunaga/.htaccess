###           nu11secur1ty_nobunaga_Apache_patch_hardening                ###
#############################################################################
### This file is free software: you can redistribute it and/or modify     ###
### it under the terms of the GNU General Public License as published by  ###
### the Free Software Foundation, either version 3 of the License, or     ###
### any later version.                                                    ###
###                                                                       ###
### This file is distributed in the hope that it will be useful,          ###
### but WITHOUT ANY WARRANTY; without even the implied warranty of        ###
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the          ###
### GNU General Public License for more details.                          ###
###                  COPY RIGHT @ nu11secur1ty //Publix v 1.0             ###
### http://www.nu11secur1ty.com/2017/08/nobonagaapachepatch.html          ###
### All rights reserved 2019 Author V.Varbanovski @nu11secur1ty           ###   
#############################################################################

# WARNING! DO NOT EDIT THIS FILE!!!


# Options_mod
  Options -Includes
  Options -ExecCGI
  Options -Indexes
  FileETag None


### RESTRICT HTTPS ###
RewriteEngine on
RewriteCond %{HTTP_HOST} _your_domain_name\._com_or [NC]
RewriteCond %{REQUEST_URI} ^/$
RewriteRule ^(.*)$ /blog/$1 [L]
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"


### RDIRECT HTTPS ###
RewriteEngine On 
RewriteCond %{SERVER_PORT} 80 
RewriteRule ^(.*)$ https://www._your_domain.com/$1 [R,L]


##### Content Security Policy ######
Header always set Content-Security-Policy "default-src https: data: 'unsafe-inline' 'unsafe-eval'"


### Block Scanners ###
    RewriteCond %{HTTP_USER_AGENT} ^w3af.sourceforge.net [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} dirbuster [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} nikto [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} SF [OR]
    RewriteCond %{HTTP_USER_AGENT} sqlmap [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} fimap [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} nessus [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} whatweb [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} Openvas [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} jbrofuzz [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} libwhisker [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} webshag [NC,OR]
    RewriteCond %{HTTP:Acunetix-Product} ^WVS
    #RewriteRule ^.* http://127.0.0.1/ [R=301,L]

### BLOCK SOME USER AGENTS
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|curl|wget|python|nikto|scan) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (<|>|â€™|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]


### QUERY STRING EXPLOITS
    RewriteCond %{QUERY_STRING} boot\.ini [NC,OR]
    RewriteCond %{QUERY_STRING} tag\= [NC,OR]
    RewriteCond %{QUERY_STRING} ftp\: [NC,OR]
    RewriteCond %{QUERY_STRING} http\:  [NC,OR]
    RewriteCond %{QUERY_STRING} https\: [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(%0|127\.0).* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(\(|\)|<|>|'|"|\?|\*|%%|&%%|&"|').* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(\(|\)|<|>|'|"|\?|\*|%%|&%%|&'|").* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(globals|encode|localhost|loopback).* [NC,OR]
    RewriteCond %{QUERY_STRING} (;|<|>|â€™|â€|\)|%0A|%0D|%22|%27|%3C|%3E|%00).*(/\*|union|select|insert|cast|set|declare|drop|md5|benchmark) [NC,OR]
    RewriteCond %{QUERY_STRING} \.\./\.\. [OR]
    RewriteCond %{QUERY_STRING} (<|>|â€™|%0A|%0D|%27|%3C|%3E|%00) [NC]
    RewriteRule ^(.*)$ - [R=404,L]



### FILTER REQUEST METHODS AND OTHER STUFF
    RewriteCond %{REQUEST_METHOD} ^(TRACE|DELETE|TRACK) [NC,OR]
    RewriteCond %{THE_REQUEST} (\\r|\\n|%0A|%0D) [NC,OR]
    RewriteCond %{HTTP_REFERER} (<|>|â€™|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{HTTP_COOKIE} (<|>|â€™|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{REQUEST_URI} ^/(,|;|:|<|>|â€>|â€<|/|\\\.\.\\).{0,9999} [NC,OR]


# Security Headers
# nu11secur1ty

<IfModule mod_headers.c> 
  Header set X-XSS-Protection "1; mode=block"
  Header set X-XSS-Protection: 1
  Header always set X-XSS-Protection "1; mode=block"
  # Mozilla developers
  Header always set X-Frame-Options SAMEORIGIN
  Header set X-Frame-Options DENY
  Header set X-Frame-Options "ALLOW-FROM https://your_domain.com/"
  #-----------------------------------------
  
</IfModule>

<IfModule mod_headers.c>
  Header set X-Frame-Options DENY
  Header set X-Frame-Options: DENY
  Header always set X-Frame-Options: DENY
</IfModule>

<IfModule mod_headers.c>
  Header set X-Content-Type-Options nosniff
  Header set X-Content-Type-Options: nosniff
  Header always set X-Content-Type-Options: nosniff
</IfModule>

# Do not uncomment here! 
#<IfModule mod_headers.c>  
#  Header always set X-Download-Options: noopen 
#</IfModule>

# Securing from google_maps_and other_shits...
#<IfModule mod_headers.c>
#  Header set Content-Security-Policy "script-src 'self'; object-src 'self'" 
#</IfModule>


# More HEADER SECURITY
# Note: instead of adding your own configuration here, consider 
#       adding it in your own file (/etc/apache2/httpd.conf.local)
#       putting its name into APACHE_CONF_INCLUDE_FILES in 
#       /etc/sysconfig/apache2 -- this will make system updates 
#       easier :) 


# Nikto issue
#<filesMatch "\.(php)$">
#Header always append X-Frame-Options DENY
#</filesMatch>
#FileETag None
#Header unset ETag


# X.. Protection
#   TraceEnable off
#   ServerSignature Off
#   ServerTokens Prod
# Header always append X-Frame-Options SAMEORIGIN
# Header set X-Content-Type-Options "nosniff"
# Header always set X-XSS-Protection "1; mode=block"
# Header set X-XSS-Protection: 1


# WARNING! DO NOT EDIT THIS PART!!!

# Disable HTTP Methods: OPTIONS, GET, HEAD, POST
#   <Limit GET POST HEAD OPTIONS>
#    <Limit OPTIONS>
#        Order allow,deny
#        Allow from all  
#   </Limit>     
#   <LimitExcept GET POST HEAD OPTIONS>
#        Order deny,allow
#        Deny from all   
#   </LimitExcept>


# mod_apparmor: ENABLING
# a2enmod apparmor php5
# 2enmod apparmor && sudo systemctl reload apache2
# zypper in -t pattern apparmor


# Redirect 
ErrorDocument 404 /404.html
# ErrorDocument 403 /404.html
# ErrorDocument 500 /404.html
# ErrorDocument 401 /404.html

###################################################

# Kristian Yanakiev
RewriteRule ^thumb([0-9]+)\.(png|jpg|gif|svg|pic)$    /viewimage.php?id=$1&format=$2&thumb=1 [NC,L]
RewriteRule ^image([0-9]+)\.(png|jpg|gif|svg|pic)$    /viewimage.php?id=$1&format=$2 [NC,L]

